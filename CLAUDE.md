# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This repository tracks and visualizes contributor and stargazer metrics for Autoware Foundation repositories. It generates JSON data files from GitHub's GraphQL API and displays interactive charts on a GitHub Pages site showing:
- GitHub star growth over time across repositories
- Contributor growth (code contributors, community contributors, and total)

Live site: https://autowarefoundation.github.io/autoware-contributor-metrics/index.html

## Development Workflow

### Running locally

The data collection and processing pipeline consists of six scripts that must be run in order:

```bash
# 0. Fetch and generate repository list from GitHub API
python scripts/fetch_repositories.py --token <GitHubToken>

# 1. Fetch contributor data (issues, PRs, discussions) from GitHub GraphQL API
python scripts/get_contributors.py --token <GitHubToken>

# 2. Fetch stargazer data from GitHub GraphQL API
python scripts/get_stargazers.py --token <GitHubToken>

# 3. Process contributor data into cumulative history
python scripts/calculate_contributor_history.py

# 4. Process stargazer data into cumulative history
python scripts/calculate_stargazers_history.py

# 5. Calculate contributor rankings
python scripts/calculate_rankings.py

# 6. Copy results to public folder
cp results/contributors_history.json results/stars_history.json results/rankings.json public/
```

Alternatively, use the `GITHUB_TOKEN` environment variable instead of `--token`:
```bash
export GITHUB_TOKEN=<your_token>
python scripts/get_contributors.py
```

For incremental updates (faster, fetches only new data since last run):
```bash
python scripts/get_contributors.py --use-cache
python scripts/get_stargazers.py --use-cache
```

### Installing dependencies

```bash
pip install -r requirements.txt
```

The only external dependency is `requests>=2.31.0`.

### Viewing the dashboard locally

Start a local server and open in a browser:
```bash
cd public
python -m http.server 8000
# Visit http://localhost:8000/index.html
```

The page expects `contributors_history.json`, `stars_history.json`, `rankings.json`, and `repositories.json` to be in the `public/` directory.

## Architecture

### Data Pipeline Flow

```
GitHub GraphQL API
    ↓
0. fetch_repositories.py → public/repositories.json
1. get_contributors.py → cache/raw_contributor_data/*.json
2. get_stargazers.py → cache/raw_stargazer_data/*.json
    ↓
3. calculate_contributor_history.py → results/contributors_history.json
4. calculate_stargazers_history.py → results/stars_history.json
5. calculate_rankings.py → results/rankings.json
    ↓
Copy to public/ → Visualized in index.html
```

### Key Components

**Data Fetchers** (`scripts/get_contributors.py` and `scripts/get_stargazers.py`):
- Use GitHub GraphQL API to fetch raw data from 24+ Autoware repositories
- Implement rate limiting, retry logic, and error handling
- Pagination: fetch 100 items per page, tracking cursors
- Store raw JSON in `cache/` directories

**Data Processors** (`scripts/calculate_contributor_history.py` and `scripts/calculate_stargazers_history.py`):
- Parse cached JSON files
- Track first contribution/star date per user
- Generate cumulative daily counts
- Output time-series data to `results/`

**Rankings Calculator** (`scripts/calculate_rankings.py`):
- Generates monthly and yearly contributor rankings
- Four ranking categories: MVP, Best Committer (merged PRs), Best Evangelist (issues/discussions), Best Reviewer (PR reviews)
- MVP requires appearing in all three categories; ranked by sum of ranks
- Excludes bot accounts (dependabot, github-actions, etc.)

**Visualization** (`public/main.js` and `public/index.html`):
- Uses ApexCharts to render interactive line charts
- Fetches JSON from `stars_history.json` and `contributors_history.json`
- Displays total metrics plus breakdown by repository/contributor type

### Contributor Types

The repository distinguishes between:
- **Code contributors**: Users who created PRs
- **Community contributors**: Users who created issues/discussions or commented
- **Total contributors**: Union of both types (earliest contribution date tracked)

### Repository List

The repository list is dynamically generated by `fetch_repositories.py` and stored in `public/repositories.json`. This script:
- Fetches all repositories from autowarefoundation organization
- Excludes archived repositories
- Excludes repositories not updated within 2 years (except autoware_ai legacy repos)
- Selects top 25 by composite score (stars + forks)
- Includes all autoware_ai legacy repositories for historical tracking

The `repositories.py` module loads this JSON file and provides the `REPOSITORIES` list for other scripts.

## GitHub Actions

The workflow `.github/workflows/measure-contributors.yml`:
- Runs daily via cron (`0 0 * * *`) and on push to main
- Uses a secret `ACCESS_TOKEN` for GitHub API access
- Runs all six scripts in sequence with `--use-cache` for incremental fetching
- Uses `actions/cache` to persist cache directory between workflow runs
- Copies results to `public/` and deploys to GitHub Pages
- Archives raw cache and results as workflow artifacts

## Important Implementation Details

### Rate Limiting Strategy

Both fetcher scripts implement sophisticated rate limiting:
- Check `X-RateLimit-Remaining` header before each request
- Wait until rate limit reset if < 10 requests remaining
- Exponential backoff on 403 errors (up to 5 retries)
- 1 second delay between successful requests

### Data Deduplication

- **Contributors**: Track earliest contribution date per username across all repos
- **Stargazers**: `calculate_stargazers_history.py` counts unique stargazers across repos (same user starring multiple repos counts once)

### Date Filtering

Contributor history starts from January 1, 2022 (`ContributorHistory.start_date`). Earlier contributions are ignored.

### Incremental Caching

When using `--use-cache`, fetcher scripts:
- Load existing cached data and extract the last cursor
- Fetch only new data starting from that cursor
- Merge new data with cached data and save

## File Structure

```
.
├── scripts/
│   ├── fetch_repositories.py            # Fetch and filter repository list
│   ├── repositories.py                  # Load repositories from JSON
│   ├── get_contributors.py              # Fetch issues/PRs/discussions
│   ├── get_stargazers.py                # Fetch stargazers
│   ├── calculate_contributor_history.py # Process contributors
│   ├── calculate_stargazers_history.py  # Process stargazers
│   └── calculate_rankings.py            # Calculate contributor rankings
├── public/
│   ├── index.html                       # Dashboard HTML
│   ├── main.js                          # Visualization logic
│   └── repositories.json                # Repository list (generated)
├── cache/                               # Raw API responses (gitignored)
│   ├── raw_contributor_data/
│   └── raw_stargazer_data/
├── results/                             # Processed JSON (gitignored)
│   ├── contributors_history.json
│   ├── stars_history.json
│   └── rankings.json
├── requirements.txt
└── README.md
```
